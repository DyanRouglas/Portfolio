---
title: "KT_analysis"
author: "Ryan Douglas"
date: "10/14/2019"
output:
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(xlsx)
library(ggpubr)
library(RColorBrewer)
library(scales)
library(ggplot2)
theme_set(
  theme_minimal() +
    theme(legend.position = "right")
  )
```

```{r warning=FALSE}
ID <- read.xlsx("/Users/DyanRouglas/Documents/Yale_data/SFN/SFN_10KT_18ControlNew.xlsx", 1)
Pulse <- read.xlsx("/Users/DyanRouglas/Documents/Yale_data/PulseOximeter/PulseOxRespirationFinal.xlsx", 1)
Pulse$Stim <- as.character(Pulse$Stim)
Pulse$Condition <- as.factor(Pulse$Condition)
```

```{r}
pulse <- filter(Pulse, ScanID %in% ID$Scan_ID)


pulse$Group <- NA
for (i in 1:nrow(pulse)) {
  id <- as.character(pulse$SecondID[i])
  id <- substr(id, 1, 4)
  
  stim <- as.character(pulse$Stim[i])
  stim <- substr(stim, 1, 4) 
  
  if (is.na(id)) {
    # Placeholder
    id <- ""
  }
  if (id == "MMKT") {
    pulse$Group[i] <- "Trauma"
  } else {
    pulse$Group[i] <- "Control"
  }
  
  # Uncomment to remove baseline scans
  # if (stim == "Stim") {
  #   pulse$Stim[i] <- "Stim"
  # }
}
# pulse <- filter(pulse, Stim == "Stim")

pulseHR <- filter(pulse, SignalQuality != 4)
pulseRMSSD <- filter(pulse, SignalQuality == 1)
pulseResp <- filter(pulse, RespSignalQuality != 4)

for (i in 1:nrow(pulseHR)) {
  scan <- as.character(pulseHR$ScanID[i])
  if (!(scan %in% ID$Scan_ID)) {
    print(paste0("Missing clean HR for: ", scan))
  }
}

for (i in 1:nrow(pulseRMSSD)) {
  scan <- as.character(pulseRMSSD$ScanID[i])
  if (!(scan %in% ID$Scan_ID)) {
    print(paste0("Missing clean RMSSD for: ", scan))
  }
}

for (i in 1:nrow(pulseHR)) {
  scan <- as.character(pulseResp$ScanID[i])
  if (!(scan %in% ID$Scan_ID)) {
    print(paste0("Missing clean Respiration for: ", scan))
  }
}



print(paste0("Number of subjects with clean heart rate data: ",
             " Trauma - ", length(unique(filter(pulseHR, Group == "Trauma")$ScanID)),
             " Control - ", length(unique(filter(pulseHR, Group == "Control")$ScanID))))
print(paste0("Number of subjects with clean RMSSD data: ", 
             " Trauma - ", length(unique(filter(pulseRMSSD, Group == "Trauma")$ScanID)),
             " Control - ", length(unique(filter(pulseRMSSD, Group == "Control")$ScanID))))
print(paste0("Number of subjects with clean respiration data: ", 
             " Trauma - ", length(unique(filter(pulseResp, Group == "Trauma")$ScanID)),
             " Control - ", length(unique(filter(pulseResp, Group == "Control")$ScanID))))
```


## Check to see if data is normally distributed 


```{r}
ggqqplot(pulseHR$HR) + labs(title = "HR qqplot")
shapiro.test(pulseHR$HR)
```

```{r}
ggqqplot(pulseRMSSD$RMSSD) + labs(title = "RMSSD qqplot")
shapiro.test(pulseRMSSD$RMSSD)
```

```{r}
ggqqplot(pulseResp$Respiration) + labs(title = "Respiration qqplot")
shapiro.test(pulseResp$Respiration)
```


From the above qqplots and Shapiro-Wilk normality tests, we can see that none
of the variables from our sample are normally distributed. This just could be
because I didn't group by Condition. Regardless, it's good to account for this
in the upcoming analysis.


# Analysis of HR: Trauma vs Control

### Two Sample T-test and Wilcox test

T-tests operate under the assumption that the data is normally distributed.
Because the above normaility tests suggested otherwise, I'm also including
a Wilcox test which doesn't have the assumption of normality.


```{r}
hr_by_group <- t.test(HR ~ Group, data = pulseHR, var.equal = TRUE)
hr_by_group_wilcox <- wilcox.test(HR ~ Group, data = pulseHR)

hr_by_group
hr_by_group_wilcox
```

Both the two sample t-test and the Wilcox test show significant differences
between heart rate in controls and trauma individuals. This is shown in the 
boxplot below. The p value is given by the Wilcox test.

```{r warning=FALSE}
groups = list(c("Control", "Trauma"))
ggplot(pulseHR, aes(x = Group, y = HR, fill = Group)) +
  geom_boxplot(outlier.color = "black") +
  labs(title = "Heart Rate by Group", y = "Heart Rate") +
  scale_fill_brewer(palette = "Pastel1") +
  stat_compare_means(aes(label = paste0("*p =", ..p.format..)), 
                        label.x = 1.65, label.y = 95)



```


### ANOVA and Tukey multiple pairwise-comparisons


Below is the output of an ANOVA test and a Tukey HSD (Honest Significant
Differences) fitted to the ANOVA model. The Tukey portion of the output is
more useful for our purposes as it shows comparisons on the Group level ($Group), 
the Condition level ($Condition), and the Group by Condition level,
($Group:Condition).


```{r}
anovaHR <- aov(HR ~ Group * Condition, data = pulseHR)
summary(anovaHR)

TukeyHSD(anovaHR)
```


### Heart Rate Boxplots


Below is a boxplot of heart rate by condition. THe p values are not taken from
the ANOVA/Tukey model but are computed from a pairwise Wilcox test 


```{r}
conditions <- list(c("A", "N"), c("A", "S"), c("N", "S"))

ggplot(pulseHR, aes(x = Condition, y = HR, fill = Condition)) +
  geom_boxplot(outlier.color = "black") +
  labs(title = "Heart Rate by Condition", y = "Heart Rate") +
  scale_fill_brewer(palette = "Pastel1") +
  stat_compare_means(comparisons = conditions)
```


Below is a boxplot of heart rate by Group and Condition. Similar to the plot
above, the p values are not taken from the ANOVA/Tukey but are computed from
a pairwise Wilcox test. I can change this to a standard t-test easily if that
is preferred. Wilcox is just the default. 

As a side note, I had difficulty adding bars in this plot like I did in the one
above. The additional grouping variable complicates it somewhat but I'm sure I 
could figure it out if it's preferred that way.


```{r}
ggplot(pulseHR, aes(x = Condition, y = HR, fill = Group)) +
  geom_boxplot(outlier.color = "black") +
  labs(title = "Heart Rate by Group and Condition", y = "Heart Rate") +
  scale_fill_brewer(palette = "Pastel1") +
  stat_compare_means(label = "p.format", label.y = 98)
```


```{r}
pulseHR_SN <- filter(pulseHR, Condition != "A")
pulseHR_SN$Condition <- gsub("N", "Neutral", pulseHR_SN$Condition)
pulseHR_SN$Condition <- gsub("S", "Stress", pulseHR_SN$Condition)

pdf('/Users/DyanRouglas/Documents/Yale_data/SFN/HR_KTvsControl.pdf')

HR_plot <- ggplot(pulseHR_SN, aes(x = Condition, y = HR, fill = Group)) +
  geom_boxplot(outlier.color = "black") +
  labs(title = "Heart Rate by Group and Condition", y = "Heart Rate") +
  scale_fill_brewer(palette = "Pastel1") +
  stat_compare_means(label = "p.format", label.y = 98)

print(HR_plot)
dev.off()

```


# Analysis of RMSSD: Trauma vs Control

### Two Sample T-test and Wilcox test


```{r}
rmssd_by_group <- t.test(RMSSD ~ Group, data = pulseRMSSD, var.equal = TRUE)
rmssd_by_group_wilcox <- wilcox.test(RMSSD ~ Group, data = pulseRMSSD)

rmssd_by_group
rmssd_by_group_wilcox
```


Interestingly, the t-test isn't showing a significant difference in RMSSD 
between Trauma and Controls but the Wilcox test is. 


```{r}
groups = list(c("Control", "Trauma"))
ggplot(pulseRMSSD, aes(x = Group, y = RMSSD, fill = Group)) +
  geom_boxplot(outlier.color = "black") +
  labs(title = "RMSSD by Group", y = "RMSSD") +
  scale_fill_brewer(palette = "Pastel1") +
  stat_compare_means(aes(label = paste0("*p =", ..p.format..)), 
                        label.x = 1.65, label.y = 150)
```


The p value on the above plot, and remaining plots, is from the WIlcox test.


### ANOVA and Tukey multiple pairwise-comparisons


```{r}
anovaRMSSD <- aov(RMSSD ~ Group * Condition, data = pulseRMSSD)
summary(anovaRMSSD)

TukeyHSD(anovaRMSSD)
```


There doesn't seem to be anything interesting from the ANOVA/Tukey models.


### RMSSD Boxplots


```{r}
conditions <- list(c("A", "N"), c("A", "S"), c("N", "S"))

ggplot(pulseRMSSD, aes(x = Condition, y = RMSSD, fill = Condition)) +
  geom_boxplot(outlier.color = "black") +
  labs(title = "RMSSD by Condition", y = "RMSSD") +
  scale_fill_brewer(palette = "Pastel1") +
  stat_compare_means(comparisons = conditions)

```


However, the mean difference between alcohol and neutral is significant and
the difference between neutral and stress is borderline significant.


```{r}
ggplot(pulseRMSSD, aes(x = Condition, y = RMSSD, fill = Group)) +
  geom_boxplot(outlier.color = "black") +
  labs(title = "RMSSD by Group and Condition", y = "RMSSD") +
  scale_fill_brewer(palette = "Pastel1") +
  stat_compare_means(label = "p.format", label.y = 205)
```


It's interesting that the mean RMSSD for the trauma is so low compared to the 
3rd quartile in the alcohol condition. I bet the 3rd quartile would shrink 
dramatically as more subjects were added.



# Analysis of Respiration: Trauma vs Control


### Two Sample T-test and Wilcox test


```{r}
resp_by_group <- t.test(Respiration ~ Group, data = pulseResp, var.equal = TRUE)
resp_by_group_wilcox <- wilcox.test(Respiration ~ Group, data = pulseResp)

resp_by_group
resp_by_group_wilcox
```


Both the t-test and the Wilcox test are showing significant group differences
for respiration.


```{r}
groups = list(c("Control", "Trauma"))
ggplot(pulseResp, aes(x = Group, y = Respiration, fill = Group)) +
  geom_boxplot(outlier.color = "black") +
  labs(title = "Respiration by Group", y = "Respiration") +
  scale_fill_brewer(palette = "Pastel1") +
  stat_compare_means(aes(label = paste0("*p =", ..p.format..)), 
                        label.x = 1.65, label.y = 22)


```



### ANOVA and Tukey multiple pairwise-comparisons

```{r}
anovaResp <- aov(Respiration ~ Group * Condition, data = pulseResp)
summary(anovaResp)

TukeyHSD(anovaResp)
```


### Respiration Boxplots


```{r}
conditions <- list(c("A", "N"), c("A", "S"), c("N", "S"))

ggplot(pulseResp, aes(x = Condition, y = Respiration, fill = Condition)) +
  geom_boxplot(outlier.color = "black") +
  labs(title = "Respiration by Condition", y = "Respiration") +
  scale_fill_brewer(palette = "Pastel1") +
  stat_compare_means(comparisons = conditions)

```


The difference between stress and neutral is approaching significance.


```{r}
ggplot(pulseResp, aes(x = Condition, y = Respiration, fill = Group)) +
  geom_boxplot(outlier.color = "black") +
  labs(title = "Respiration by Group and Condition", y = "Respiration") +
  scale_fill_brewer(palette = "Pastel1") +
  stat_compare_means(label = "p.format", label.y = 22.5)
```


Respiration rate is significantly higher in the trauma group during the stress 
cue.


```{r}
pulseResp_SN <- filter(pulseResp, Condition != "A")
pulseResp_SN$Condition <- gsub("N", "Neutral", pulseResp_SN$Condition)
pulseResp_SN$Condition <- gsub("S", "Stress", pulseResp_SN$Condition)

pdf('/Users/DyanRouglas/Documents/Yale_data/SFN/Resp_KTvsControl.pdf')

Resp_plot <- ggplot(pulseResp_SN, aes(x = Condition, y = Respiration, fill = Group)) +
  geom_boxplot(outlier.color = "black") +
  labs(title = "Respiration by Group and Condition", y = "Respiration") +
  scale_fill_brewer(palette = "Pastel1") +
  stat_compare_means(label = "p.format", label.y = 22.5)

print(Resp_plot)
dev.off()
```

```{r}
conditionMeanHR <- group_by(pulseHR, Group) %>%
             summarize(HR  = mean(HR, na.rm = TRUE))
conditionSD <- group_by(pulseHR, Group) %>%
             summarize(SD  = sd(HR, na.rm = TRUE))
conditionCount <- group_by(pulseHR, Group) %>%
             count()

conditionSummary <- cbind(conditionMeanHR, N = conditionCount$n, SD = conditionSD$SD)
conditionSummary$SE <- NA

for (i in 1:nrow(conditionSummary)) {
  sd <- conditionSummary$SD[i]
  n <- conditionSummary$N[i]
  conditionSummary$SE[i] <- sd/sqrt(n)
}

```


```{r}
pdf('/Users/DyanRouglas/Documents/Yale_data/SFN/HR_KTvsControl_bar.pdf')

HR_plot <- ggplot(conditionSummary, aes(x = Group, y = HR, fill = Group)) +
  geom_bar(stat="identity", position=position_dodge()) +
  labs(title = "Heart Rate by Group", y = "Heart Rate (BPM)") +
  scale_fill_brewer(palette = "Pastel1") +
  geom_errorbar(aes(ymin= HR - SE, ymax= HR + SE), width = .15) +
  scale_y_continuous(breaks = seq(50, 75, 5), limits=c(50,75),oob = rescale_none) 
  

 print(HR_plot)
 dev.off()
HR_plot
```


```{r}
pdf('/Users/DyanRouglas/Documents/Yale_data/SFN/HR_KTvsControl_bar_SD.pdf')

HR_plotSD <- ggplot(conditionSummary, aes(x = Group, y = HR, fill = Group)) +
  geom_bar(stat="identity", position=position_dodge()) +
  labs(title = "Heart Rate by Group", y = "Heart Rate (BPM)") +
  scale_fill_brewer(palette = "Pastel1") +
  geom_errorbar(aes(ymin= HR - SD, ymax= HR + SD), width = .15) +
  scale_y_continuous(breaks = seq(30, 90, 5), limits=c(30,85),oob = rescale_none) 
  

  print(HR_plotSD)
  dev.off()
HR_plot
```


```{r}
conditionMeanResp <- group_by(pulseResp, Group) %>%
             summarize(Respiration  = mean(Respiration, na.rm = TRUE))
conditionSD <- group_by(pulseResp, Group) %>%
             summarize(SD  = sd(Respiration, na.rm = TRUE))
conditionCount <- group_by(pulseResp, Group) %>%
             count()

conditionSummaryResp <- cbind(conditionMeanResp, N = conditionCount$n, SD = conditionSD$SD)
conditionSummaryResp$SE <- NA

for (i in 1:nrow(conditionSummaryResp)) {
  sd <- conditionSummaryResp$SD[i]
  n <- conditionSummaryResp$N[i]
  conditionSummaryResp$SE[i] <- sd/sqrt(n)
}

```



```{r}
pdf('/Users/DyanRouglas/Documents/Yale_data/SFN/Resp_KTvsControl_bar.pdf')

Resp_plot <- ggplot(conditionSummaryResp, aes(x = Group, y = Respiration, fill = Group)) +
  geom_bar(stat="identity", position=position_dodge()) +
  labs(title = "Respiration by Group", y = "Respiration (per minute)") +
  scale_fill_brewer(palette = "Pastel1") +
  geom_errorbar(aes(ymin= Respiration - SE, ymax= Respiration + SE), width = .15) +
  scale_y_continuous(breaks = seq(10, 18, 2), limits=c(12,18),oob = rescale_none) 

print(Resp_plot)
dev.off()
Resp_plot
```


```{r}
pdf('/Users/DyanRouglas/Documents/Yale_data/SFN/Resp_KTvsControl_bar_SD.pdf')

Resp_plotSD <- ggplot(conditionSummaryResp, aes(x = Group, y = Respiration, fill = Group)) +
  geom_bar(stat="identity", position=position_dodge()) +
  labs(title = "Respiration by Group", y = "Respiration (per minute)") +
  scale_fill_brewer(palette = "Pastel1") +
  geom_errorbar(aes(ymin= Respiration - SD, ymax= Respiration + SD), width = .15) +
  scale_y_continuous(breaks = seq(10, 20, 2), limits=c(10,20),oob = rescale_none) 

print(Resp_plotSD)
dev.off()
Resp_plot
```



```{r}
conditionMeanRMSSD <- group_by(pulseRMSSD, Group) %>%
             summarize(RMSSD  = mean(RMSSD, na.rm = TRUE))
conditionSD <- group_by(pulseRMSSD, Group) %>%
             summarize(SD  = sd(RMSSD, na.rm = TRUE))
conditionCount <- group_by(pulseRMSSD, Group) %>%
             count()

conditionSummaryRMSSD <- cbind(conditionMeanRMSSD, N = conditionCount$n, SD = conditionSD$SD)
conditionSummaryRMSSD$SE <- NA

for (i in 1:nrow(conditionSummaryRMSSD)) {
  sd <- conditionSummaryRMSSD$SD[i]
  n <- conditionSummaryRMSSD$N[i]
  conditionSummaryRMSSD$SE[i] <- sd/sqrt(n)
}
```

```{r}
pdf('/Users/DyanRouglas/Documents/Yale_data/SFN/RMSSD_KTvsControl_bar.pdf')

RMSSD_plot <- ggplot(conditionSummaryRMSSD, aes(x = Group, y = RMSSD, fill = Group)) +
  geom_bar(stat="identity", position=position_dodge()) +
  labs(title = "RMSSD by Group", y = "RMSSD") +
  scale_fill_brewer(palette = "Pastel1") +
  geom_errorbar(aes(ymin= RMSSD - SE, ymax= RMSSD + SE), width = .15) +
  scale_y_continuous(breaks = seq(40, 80, 5), limits=c(45,75),oob = rescale_none) 

print(RMSSD_plot)
dev.off()

RMSSD_plot
```


```{r}
pdf('/Users/DyanRouglas/Documents/Yale_data/SFN/RMSSD_KTvsControl_bar_SD.pdf')

RMSSD_plotSD <- ggplot(conditionSummaryRMSSD, aes(x = Group, y = RMSSD, fill = Group)) +
  geom_bar(stat="identity", position=position_dodge()) +
  labs(title = "RMSSD by Group", y = "RMSSD") +
  scale_fill_brewer(palette = "Pastel1") +
  geom_errorbar(aes(ymin= RMSSD - SD, ymax= RMSSD + SD), width = .15) +
  scale_y_continuous(breaks = seq(0, 150, 10), limits=c(0,120),oob = rescale_none) 

print(RMSSD_plotSD)
dev.off()

RMSSD_plotSD
```

